---
title: "Election Tweets 2022 - Partisanship and Competitiveness"
author: "Keith Colella"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, message = FALSE}
library(tidyverse)
library(infer)
library(tigris)
library(sf)
library(kableExtra)
library(cowplot)

set.seed(1989)
```

## Data

Primary data

```{r}
candidates <- read_csv('data/candidates_partisan_compete.csv')

glimpse(candidates)

candidates <- candidates %>%
  select(name, state, district, party, incumbent_challenge, # candidate_status,
         contains('partisan'), contains('compete'))

candidates <- candidates[!duplicated(candidates),]

candidates[duplicated(candidates$name) | duplicated(candidates$name, fromLast = TRUE),]
```

Mapping Data

```{r}
data('fips_codes')

districts_sf <- congressional_districts() %>% 
  st_simplify(dTolerance = 10000) %>%
  data.frame() %>%
  left_join(
    fips_codes %>%
      select(state, state_code) %>%
      unique(), 
    by = c('STATEFP' = 'state_code')
  )

states_sf <- states(cb = TRUE) %>% 
  st_simplify(dTolerance = 1000) %>%
  data.frame() %>%
  filter(STUSPS != 'AS',
         STUSPS != 'GU',
         STUSPS != 'MP',
         STUSPS != 'VI',
         STUSPS != 'PR',)

candidates_sf <- candidates %>%
  left_join(
    select(districts_sf, state, CD116FP, geometry),
    by = c('state', 'district' = 'CD116FP'),
  ) %>%
  left_join(
    select(states_sf, STUSPS, geometry), suffix = c('_distr','_state'),
    by = c('state' = 'STUSPS')
  )
```

## EDA

Spread across states

```{r}
state_bar_plot <- function (data, filter_column) {
  data %>%
    mutate(dupe = duplicated(name)) %>%
    filter(!is.na(!! sym(filter_column)),
           dupe == FALSE) %>%
    group_by(state) %>% 
    summarise(count = n()) %>% 
    ggplot(aes(x = reorder(state, count), y = count)) +
    geom_bar(stat = 'identity') +
    scale_x_discrete(guide = guide_axis(n.dodge = 3)) +
    xlab(filter_column) +
    coord_flip()
}

state_plots <- lapply(c('name','partisan_score_twitter',
                        'partisan_score_nominate','partisan_score_govtrack'), 
                      state_bar_plot, data = candidates)

plot_grid(plotlist = state_plots, nrow = 2, ncol = 2)
```

Spread across parties

```{r}
party_bar_plot <- function (data, filter_column) {
  data %>%
    mutate(dupe = duplicated(name)) %>%
    filter(!is.na(!! sym(filter_column)), dupe == FALSE,
           party == 'DEMOCRATIC PARTY' | party == 'REPUBLICAN PARTY') %>%
    group_by(party) %>% 
    summarise(count = n()) %>% 
    ggplot(aes(x = reorder(party, count), y = count)) +
    geom_bar(stat = 'identity') +
    xlab(filter_column)
}

party_plots <- lapply(c('name','partisan_score_twitter',
                        'partisan_score_nominate','partisan_score_govtrack'), 
                      party_bar_plot, data = candidates)

plot_grid(plotlist = party_plots, nrow = 2, ncol = 2)
```

Efficiency and Partisanship

```{r}
scatterplot <- function(x,y) {
  candidates %>%
  filter(!is.na(!! sym(x)),
         !is.na(!! sym(y))) %>%
  ggplot(aes(x = !! sym(x), y = !! sym(y))) +
  geom_point() +
  geom_smooth(method = 'lm', formula = 'y ~ x') +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(size = 10)) +
  labs(title = str_c(str_remove_all(x, 'compete|_'), '-',
                     str_remove_all(y, 'partisan_score|_')))
}

var_grid <- expand_grid(
  x = colnames(select(candidates, contains('compete'))),
  y = colnames(select(candidates, contains('partisan')))
)

plot_list <- list()

for (row in 1:nrow(var_grid)) {
  plot <- scatterplot(as.character(var_grid[row,'x']),
                      as.character(var_grid[row,'y']))
  plot_list[[row]] <- plot
}

plot_grid(plotlist = plot_list, nrow = 3, ncol = 3)
```

Summary Stats

```{r}
cat('District Ideology\n')
summary(candidates$compete_ideology)
cat('\nDistrict Cook PVI\n')
summary(candidates$compete_cookpvi)
cat('\nDistrict Effiency Gap\n')
summary(candidates$compete_eff_gap)
```

Binary Independent Variables

```{r}
candidates <- candidates %>%
  mutate(
    compete_ideology_binary = if_else(compete_ideology > median(
      candidates$compete_ideology, na.rm = TRUE), 'high', 'low'),
    compete_cookpvi_binary = if_else(compete_cookpvi > median(
      candidates$compete_cookpvi, na.rm = TRUE), 'high', 'low'),
    compete_eff_gap_binary = if_else(compete_eff_gap > median(
      candidates$compete_eff_gap, na.rm = TRUE), 'high', 'low'))

boxplot <- function(x,y) {
  candidates %>%
  filter(!is.na(!! sym(x)),
         !is.na(!! sym(y))) %>%
  ggplot(aes(x = !! sym(x), y = !! sym(y))) +
  geom_boxplot() +
  geom_smooth(method = 'lm', formula = 'y ~ x') +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(size = 10)) +
  labs(title = str_c(str_remove_all(x, 'compete|_|binary'), '_',
                     str_remove_all(y, 'partisan_score|_')))
}

var_grid <- expand_grid(
  x = colnames(select(candidates, (contains('compete') & contains('binary')))),
  y = colnames(select(candidates, contains('partisan')))
)

plot_list <- list()

for (row in 1:nrow(var_grid)) {
  plot <- boxplot(as.character(var_grid[row,'x']),
                  as.character(var_grid[row,'y']))
  plot_list[[row]] <- plot
}

plot_grid(plotlist = plot_list, nrow = 3, ncol = 3)
```

## Hypothesis Test

Define function

```{r}
hyp_diff_means <- function(x, y, 
                           data = candidates,
                           conf_level = 0.95, 
                           bootstraps = 1000) {
  mean_diff <- data %>%
    filter(!is.na(!! sym(y)),
           !is.na(!! sym(x))) %>%
    specify(response = (!!sym(y)), explanatory = (!!sym(x))) %>%
    calculate(stat = 'diff in means', order = c('high', 'low'))
  
  null_dist <- data %>%
    filter(!is.na(!! sym(y)),
           !is.na(!! sym(x))) %>%
    specify(response = (!!sym(y)), explanatory = (!!sym(x))) %>%
    hypothesize(null = 'independence') %>%
    generate(reps = bootstraps, type = 'permute') %>%
    calculate(stat = 'diff in means', order = c('high', 'low'))
  
  pval <- null_dist %>% 
    get_p_value(obs_stat = mean_diff, direction = 'two-sided')
  
  ci <- data %>%
    filter(!is.na(!! sym(y)),
           !is.na(!! sym(x))) %>%
    specify(response = (!!sym(y)), explanatory = (!!sym(x))) %>%
    generate(reps = bootstraps, type = 'bootstrap') %>%
    calculate(stat = 'diff in means', order = c('high', 'low')) %>%
    get_ci(level = conf_level)
  
  results <- list(p_value = pval$p_value,
                  lower_ci = ci$lower_ci,
                  upper_ci = ci$upper_ci)
  
  return(results)
}
```

Test and plot heatmap

```{r}
results_df <- data.frame(var_grid, p_value = NA, lower_ci = NA, upper_ci = NA)

for (row in 1:nrow(var_grid)) {
  test_name <- str_c(str_remove_all(as.character(var_grid[row,'x']),
                                    'compete|_|binary'), '_',
                     str_remove_all(as.character(var_grid[row,'y']),
                                    'partisan_score|_'))
  
  result <- hyp_diff_means(as.character(var_grid[row,'x']),
                           as.character(var_grid[row,'y']))
  
  results_df <- results_df %>%
    mutate(
      p_value = replace(p_value,
                        x == as.character(var_grid[row,'x']) &
                          y == as.character(var_grid[row,'y']),
                        result$p_value),
      lower_ci = replace(lower_ci,
                        x == as.character(var_grid[row,'x']) &
                          y == as.character(var_grid[row,'y']),
                        result$lower_ci),
      upper_ci = replace(upper_ci,
                         x == as.character(var_grid[row,'x']) &
                           y == as.character(var_grid[row,'y']),
                         result$upper_ci))
}

results_df %>%
  mutate(x = str_remove_all(x, 'compete|binary|_'),
         y = str_remove_all(y, 'partisan_score|_')) %>% 
  ggplot(aes(factor(x, levels = c('cookpvi','ideology','effgap')), 
             factor(y, levels = c('twitter','govtrack','nominate')))) +
  geom_tile(aes(fill = p_value)) +
  geom_text(aes(label = str_c('p-value: ',format(round(p_value,3), nsmall=3),
                              '\n95% CI: ',round(lower_ci,3),
                              ' - ',round(upper_ci,3)))) +
  xlab('District Competition Measures') +
  ylab('Candidate Partisanship Measures') +
  scale_fill_gradient(low = 'darkslategray1', 
                      high = 'gray100',
                      limits = c(0,0.1),
                      oob = scales::squish)
```

