---
title: "Election Tweets 2022 - Competitiveness Scores"
author: "Keith Colella"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, message = FALSE}
library(tidyverse)
library(kableExtra)
library(tigris)
library(sf)
```

## District-Level Ideology Survey

https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/BQKU4M
"We orient our ideal points so that lower values are associated with politically left preferences and higher values with politically right preferences."
```{r}
load('data/aip_district_ideology_v2022a.RData')
district_ideology <- table
rm(table)

district_ideology %>% head()

district_ideology %>%
  filter(congress == 118) %>%
  ggplot() +
  geom_freqpoly(aes(mrp_ideology)) +
  geom_freqpoly(aes(irt_ideology_unweighted), color = 'red')

min_score <- min(district_ideology$mrp_ideology, na.rm = TRUE)
max_score <- max(district_ideology$mrp_ideology, na.rm = TRUE)

district_ideology <- district_ideology %>%
  mutate(mrp_norm = 2 * (mrp_ideology - min_score) / (max_score - min_score) - 1,
         mrp_norm_abs = abs(mrp_norm))

min_score <- min(district_ideology$irt_ideology_unweighted, na.rm = TRUE)
max_score <- max(district_ideology$irt_ideology_unweighted, na.rm = TRUE)

district_ideology <- district_ideology %>%
  mutate(itr_norm = 2 * (irt_ideology_unweighted - min_score) / (max_score - min_score) - 1,
         itr_norm_abs = abs(itr_norm))

district_ideology %>%
  filter(congress == 118) %>%
  ggplot() +
  geom_freqpoly(aes(mrp_norm)) +
  geom_freqpoly(aes(itr_norm), color = 'red')

district_ideology %>%
  filter(congress == 118) %>%
  ggplot() +
  geom_freqpoly(aes(mrp_norm_abs)) +
  geom_freqpoly(aes(itr_norm_abs), color = 'red')
```

## Cook Partisan Voting Index

https://www.cookpolitical.com/cook-pvi/2022-partisan-voting-index/district-map-and-list
```{r}
cookpvi <- read_csv('data/cook_pvi.csv')

cookpvi <- cookpvi %>%
  rename(trump2020 = trump...7,
         trump2016 = trump...9) %>%
  mutate(pvi_num = 
           case_when(str_detect(pvi,'R') ~ as.numeric(str_extract(pvi,'[0-9]+')),
                     str_detect(pvi,'D') ~ as.numeric(str_extract(pvi,'[0-9]+'))*-1,
                     TRUE ~ 0))

min_score <- min(cookpvi$pvi_num)
max_score <- max(cookpvi$pvi_num)

cookpvi <- cookpvi %>%
  mutate(pvi_abs = abs(pvi_num),
         pvi_norm = 2 * (pvi_num - min_score) / (max_score - min_score) - 1,
         pvi_norm_abs = abs(pvi_norm))

cookpvi %>%
  ggplot() +
  geom_freqpoly(aes(pvi_norm), bins = 20)

cookpvi %>%
  ggplot() +
  geom_freqpoly(aes(pvi_abs), bins = 20, color = 'red')
```

## Efficiency Gap

Efficiency Gap
https://electionlab.mit.edu/data

```{r}
elections <- read_csv('data/1976-2020-house.csv')

elections <- elections %>%
  filter(stage == 'GEN',
         year > 2010) %>%
  mutate(yearStateDist = paste0(year, state_po, district))

elections <- elections %>% 
  group_by(yearStateDist) %>% 
  mutate(result = case_when(candidatevotes == max(candidatevotes) ~ 'winner',
                            candidatevotes != max(candidatevotes) ~ 'loser')) %>%
  ungroup()

elections <- elections %>%
  mutate(wastedVotes = case_when(result == 'winner' ~ (candidatevotes - (totalvotes %/% 2)),
                                 result == 'loser' ~ candidatevotes),
         wastedVotes = case_when(party == 'DEMOCRAT' ~ -wastedVotes,
                                 party == 'REPUBLICAN' ~ wastedVotes,
                                 TRUE ~ 0))

eff_gap <- elections %>%
  group_by(year, state_po, district) %>%
  summarize(netWastedVotes = sum(wastedVotes),
            totalVotes = sum(totalvotes),
            eff_gap = abs(netWastedVotes / totalVotes),
            .groups = 'drop') %>%
  group_by(state_po, district) %>%
  summarize(avg_eff_gap = mean(eff_gap),
            .groups = 'keep') %>%
  ungroup()

summary(eff_gap)

eff_gap %>% 
  ggplot(aes(avg_eff_gap)) +
  geom_histogram(binwidth = 0.02)
```

## Compactness Score

https://fivethirtyeight.com/features/we-drew-2568-congressional-districts-by-hand-heres-how/

## Election-Demographic Discrepancy

My own measure? Difference between partisan split of population and actual split of elected officials

## Unified Dataset

Prep data for joins

First account for states with 1 district

```{r}
one_dist_state_regex <- 'AK|WY|ND|SD|VT|DE|DC|MT'
```

Then prep the dfs themselves

```{r}
district_ideology <- district_ideology %>%
  filter(state != 'NA', !is.na(mrp_ideology), !is.na(irt_ideology_unweighted)) %>%
  mutate(cd_fips = sprintf('%04d', as.numeric(cd_fips)),
         state_code = str_sub(cd_fips, 1, 2),
         district = str_sub(cd_fips, 3, 4)) %>%
  left_join(
    data.frame(state = state.name,
               state_abb = state.abb)) %>%
  arrange(cd_fips, desc(congress)) %>%
  mutate(state_abb = if_else(is.na(state_abb), 'DC', state_abb),
         district = if_else(str_detect(state_abb,one_dist_state_regex),
                            '00',district),
         dupe = duplicated(cd_fips)) %>%
  filter(dupe == FALSE) %>%
  rename(compete_ideology = mrp_norm_abs)

cookpvi <- cookpvi %>%
  rename(state_dist = district) %>%
  mutate(state = str_sub(state_dist, 1, 2),
         district = str_sub(state_dist, 4, 5),
         district = if_else(str_detect(state, one_dist_state_regex),
                            '00', district)) %>%
  rename(compete_cookpvi = pvi_abs)

eff_gap <- eff_gap %>%
  mutate(district = sprintf('%02d', as.numeric(district)),
         district = if_else(str_detect(state_po, one_dist_state_regex),
                            '00', district)) %>%
  rename(compete_eff_gap = avg_eff_gap)
``` 

Read in candidates and join

```{r}
candidates <- read_csv('data/candidates_partisanship.csv')

candidates <- candidates %>%
  mutate(district = sprintf('%02d', district),
         district = if_else(str_detect(state, one_dist_state_regex),
                            '00', district)) %>%
  left_join(
    select(district_ideology, compete_ideology, state_abb, district),
    by = c('state' = 'state_abb', 'district')
  ) %>%
  left_join(
    select(cookpvi, compete_cookpvi, state, district),
    by = c('state', 'district')
  ) %>%
  left_join(
    select(eff_gap, compete_eff_gap, state_po, district),
    by = c('state' = 'state_po', 'district')
  )

data('fips_codes')

districts_sf <- congressional_districts() %>% 
  st_simplify(dTolerance = 10000) %>%
  data.frame() %>%
  left_join(
    fips_codes %>%
      select(state, state_code) %>%
      unique(), 
    by = c('STATEFP' = 'state_code')
  )

states_sf <- states(cb = TRUE) %>% 
  st_simplify(dTolerance = 1000) %>%
  data.frame() %>%
  filter(STUSPS != 'AS',
         STUSPS != 'GU',
         STUSPS != 'MP',
         STUSPS != 'VI',
         STUSPS != 'PR',)

candidates_sf <- candidates %>%
  left_join(
    select(districts_sf, state, CD116FP, geometry),
    by = c('state', 'district' = 'CD116FP'),
  ) %>%
  left_join(
    select(states_sf, STUSPS, geometry), suffix = c('_distr','_state'),
    by = c('state' = 'STUSPS')
  )
```

Mapping
https://cran.r-project.org/web/packages/tigris/tigris.pdf
https://ballotpedia.org/New_congressional_districts_created_after_the_2020_census


https://cdmaps.polisci.ucla.edu/
https://www.census.gov/geographies/mapping-files/time-series/geo/tiger-line-file.html

```{r}
candidates_sf %>%
  filter(state != 'HI',
         state != 'AK',
         state != 'PR') %>%
  ggplot() + 
  geom_sf(aes(geometry = geometry_distr, fill = compete_ideology)) +
  geom_sf(aes(geometry = geometry_state), color = 'blue', size = 0.5, fill = NA) +
  scale_fill_gradient(low = 'gray100', 
                      high = 'purple') + 
  theme(legend.position="bottom")

candidates_sf %>%
  filter(state != 'HI',
         state != 'AK',
         state != 'PR') %>%
  ggplot() + 
  geom_sf(aes(geometry = geometry_distr, fill = compete_cookpvi)) +
  scale_fill_gradient(low = 'gray100', 
                      high = 'purple') + 
  theme(legend.position="bottom")

candidates_sf %>%
  filter(state != 'HI',
         state != 'AK',
         state != 'PR') %>%
  ggplot() + 
  geom_sf(aes(geometry = geometry_distr, fill = compete_eff_gap)) +
  scale_fill_gradient(low = 'gray100', 
                      high = 'purple') + 
  theme(legend.position="bottom")
```

```{r}
candidates %>%
  ggplot(aes(compete_ideology, compete_cookpvi)) +
  geom_point() +
  geom_smooth(method = 'lm', formula = 'y ~ x')

candidates %>%
  ggplot(aes(compete_ideology, compete_eff_gap)) +
  geom_point() +
  geom_smooth(method = 'lm', formula = 'y ~ x')

candidates %>%
  ggplot(aes(compete_cookpvi, compete_eff_gap)) +
  geom_point() +
  geom_smooth(method = 'lm', formula = 'y ~ x')
```


Export

```{r}
write_csv(candidates, 'data/candidates_partisan_compete.csv')
```

